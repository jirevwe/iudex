# Iudex Dashboard Guide

> Comprehensive guide to using Iudex dashboards - static, server-mounted, and with analytics

## Table of Contents

1. [Overview](#overview)
2. [Static Dashboard (GitHub Pages)](#static-dashboard-github-pages)
3. [Server-Mounted Dashboard](#server-mounted-dashboard)
4. [Analytics Integration](#analytics-integration)
5. [Customization](#customization)
6. [API Reference](#api-reference)
7. [Troubleshooting](#troubleshooting)

---

## Overview

Iudex provides two dashboard deployment options:

1. **Static Dashboard** - Generate HTML/CSS/JS files for GitHub Pages, Netlify, or any static host
2. **Server-Mounted Dashboard** - Mount as middleware on Express, Fastify, or raw Node.js HTTP server

Both options share the same UI components and can optionally integrate with PostgreSQL for advanced analytics.

---

## Static Dashboard (GitHub Pages)

### Basic Setup

Generate a static dashboard from your test results:

```javascript
// iudex.config.js
export default {
  testMatch: ['tests/**/*.test.js'],

  reporters: [
    'console',
    {
      reporter: 'github-pages',
      config: {
        outputDir: 'docs',  // or '.iudex/dashboard'
        title: 'My API Tests',
        includeHistorical: true,
        historicalLimit: 50
      }
    }
  ]
};
```

### Running Tests and Generating Dashboard

```bash
# Run tests (generates results in .iudex/results/)
npx iudex run

# Dashboard is automatically generated by reporter
# Files are written to specified outputDir
```

### Generated Structure

```
docs/
‚îú‚îÄ‚îÄ index.html                      # Main dashboard page
‚îú‚îÄ‚îÄ config.js                       # Dashboard configuration
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dashboard.css          # Styling
‚îÇ   ‚îî‚îÄ‚îÄ js/
‚îÇ       ‚îú‚îÄ‚îÄ dashboard.js           # Main app
‚îÇ       ‚îú‚îÄ‚îÄ data-loader.js         # Data loading abstraction
‚îÇ       ‚îî‚îÄ‚îÄ components/            # UI components
‚îÇ           ‚îú‚îÄ‚îÄ summary-cards.js
‚îÇ           ‚îú‚îÄ‚îÄ test-table.js
‚îÇ           ‚îú‚îÄ‚îÄ governance-panel.js
‚îÇ           ‚îú‚îÄ‚îÄ security-panel.js
‚îÇ           ‚îú‚îÄ‚îÄ analytics-overview.js
‚îÇ           ‚îú‚îÄ‚îÄ flaky-tests-table.js
‚îÇ           ‚îú‚îÄ‚îÄ regressions-panel.js
‚îÇ           ‚îú‚îÄ‚îÄ trend-chart.js
‚îÇ           ‚îî‚îÄ‚îÄ endpoint-rates-table.js
‚îî‚îÄ‚îÄ data/
    ‚îú‚îÄ‚îÄ runs.json                  # Index of all runs
    ‚îî‚îÄ‚îÄ run-*.json                 # Individual run data
```

### Deploying to GitHub Pages

#### Option 1: Using `docs/` directory

```bash
# 1. Configure output to docs/
# In iudex.config.js:
#   outputDir: 'docs'

# 2. Commit and push
git add docs/
git commit -m "Add test dashboard"
git push origin main

# 3. Enable GitHub Pages in repo settings
#    Settings ‚Üí Pages ‚Üí Source: main branch /docs folder
```

#### Option 2: Using `gh-pages` branch

```bash
# 1. Install gh-pages
npm install --save-dev gh-pages

# 2. Add deploy script to package.json
{
  "scripts": {
    "deploy-dashboard": "gh-pages -d .iudex/dashboard"
  }
}

# 3. Deploy
npm run deploy-dashboard
```

#### Option 3: GitHub Actions

```yaml
# .github/workflows/test-dashboard.yml
name: Test Dashboard

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4

      - name: Install Dependencies
        run: npm ci

      - name: Run Tests
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          API_KEY: ${{ secrets.API_KEY }}
        run: npx iudex run

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
```

### Static Dashboard Features

**Included:**
- ‚úÖ Test results with filtering and search
- ‚úÖ Governance violations display
- ‚úÖ Security findings display
- ‚úÖ Historical run comparison (from `.iudex/results/`)
- ‚úÖ Git metadata tracking
- ‚úÖ Responsive design
- ‚úÖ No build tools required

**Not Included (requires server):**
- ‚ùå PostgreSQL analytics (flaky tests, regressions, trends)
- ‚ùå Real-time data updates
- ‚ùå Database-backed search

---

## Server-Mounted Dashboard

### Express Integration

```javascript
import express from 'express';
import { createExpressDashboard } from 'iudex/server/handlers/express';

const app = express();

// Mount dashboard at /test-dashboard
app.use('/test-dashboard', createExpressDashboard({
  resultsDir: '.iudex/results',
  title: 'API Test Dashboard',
  theme: 'light'
}));

app.listen(3000, () => {
  console.log('Dashboard: http://localhost:3000/test-dashboard');
});
```

### Fastify Integration

```javascript
import Fastify from 'fastify';
import { DashboardServer } from 'iudex/server/dashboard-server';

const fastify = Fastify();

const dashboardServer = new DashboardServer({
  resultsDir: '.iudex/results',
  title: 'API Test Dashboard',
  basePath: '/test-dashboard'
});

fastify.all('/test-dashboard/*', async (request, reply) => {
  // Adapt Fastify request/reply to Node.js req/res
  const res = {
    writeHead: (status, headers) => {
      reply.code(status);
      if (headers) {
        Object.entries(headers).forEach(([key, value]) => {
          reply.header(key, value);
        });
      }
    },
    end: (data) => {
      reply.send(data);
    }
  };

  await dashboardServer.handleRequest(request.raw, res);
});

fastify.listen({ port: 3000 });
```

### Raw Node.js HTTP Server

```javascript
import http from 'http';
import { DashboardServer } from 'iudex/server/dashboard-server';

const dashboardServer = new DashboardServer({
  resultsDir: '.iudex/results',
  title: 'API Test Dashboard'
});

const server = http.createServer(async (req, res) => {
  await dashboardServer.handleRequest(req, res);
});

server.listen(3000, () => {
  console.log('Dashboard: http://localhost:3000');
});
```

### Server API Endpoints

| Endpoint | Description | Response |
|----------|-------------|----------|
| `GET /` | Dashboard HTML | HTML page |
| `GET /assets/*` | Static assets | CSS, JS files |
| `GET /api/runs` | List available runs | JSON array |
| `GET /api/run/:runId` | Get run details | JSON object |
| `GET /api/analytics` | Analytics data (if DB enabled) | JSON object |

---

## Analytics Integration

### Enabling PostgreSQL Analytics

Analytics require a PostgreSQL database connection.

#### 1. Configure Database

```javascript
// iudex.config.js
export default {
  database: {
    enabled: true,
    host: process.env.DB_HOST || 'localhost',
    port: parseInt(process.env.DB_PORT) || 5432,
    database: process.env.DB_NAME || 'iudex',
    user: process.env.DB_USER || 'postgres',
    password: process.env.DB_PASSWORD,
    ssl: process.env.DB_SSL === 'true'
  },

  reporters: [
    'console',
    'postgres',  // Persist test results to PostgreSQL
    {
      reporter: 'github-pages',
      config: {
        outputDir: 'docs',
        title: 'API Tests with Analytics'
      }
    }
  ]
};
```

#### 2. Run Database Migrations

```bash
# Apply schema (creates tables and views)
psql -h localhost -U postgres -d iudex -f database/schema.sql
```

#### 3. Mount Dashboard with Analytics

```javascript
import express from 'express';
import { createExpressDashboard } from 'iudex/server/handlers/express';
import { DatabaseRepository } from 'iudex/database/repository';
import { DatabaseClient } from 'iudex/database/client';

const app = express();

// Initialize database client
const dbClient = new DatabaseClient({
  host: 'localhost',
  port: 5432,
  database: 'iudex',
  user: 'postgres',
  password: process.env.DB_PASSWORD
});

// Create repository
const repository = new DatabaseRepository(dbClient);

// Mount dashboard with analytics enabled
app.use('/test-dashboard', createExpressDashboard({
  resultsDir: '.iudex/results',
  title: 'API Test Dashboard',
  repository  // Enable analytics!
}));

app.listen(3000);
```

### Available Analytics

When PostgreSQL is connected, the Analytics tab displays:

#### 1. Flaky Tests
Tests with intermittent failures (10-90% failure rate).

**Data includes:**
- Test name and slug
- Total runs
- Failure count and rate
- Last failure timestamp

#### 2. Recent Regressions
Tests that were passing but recently started failing.

**Data includes:**
- Test name and slug
- Failure timestamp
- Number of previous passes
- Run ID

#### 3. Daily Trends
Historical test statistics over time.

**Data includes:**
- Pass rate trends
- Total runs per day
- Average duration
- Visual bar chart

#### 4. Endpoint Success Rates
API endpoint reliability metrics.

**Data includes:**
- Endpoint path and HTTP method
- Success rate percentage
- Total calls and failures
- Average duration

### Analytics API

You can also fetch analytics programmatically:

```javascript
import { fetchAnalytics } from 'iudex/server/api/analytics';

// Fetch flaky tests
const flakyTests = await fetchAnalytics(dbClient, 'flaky-tests', {
  limit: 20,
  days: 30
});

// Fetch regressions
const regressions = await fetchAnalytics(dbClient, 'regressions', {
  limit: 20,
  days: 7
});

// Fetch daily stats
const dailyStats = await fetchAnalytics(dbClient, 'daily-stats', {
  days: 30
});

// Fetch endpoint rates
const endpointRates = await fetchAnalytics(dbClient, 'endpoint-rates', {
  limit: 20,
  days: 30
});
```

---

## Customization

### Theme Customization

The dashboard uses CSS variables for easy theming:

```css
/* custom-theme.css */
:root {
  --color-primary: #8b5cf6;      /* Purple instead of blue */
  --color-success: #10b981;
  --color-error: #ef4444;
  --color-warning: #f59e0b;
  --color-bg: #ffffff;
  --color-bg-secondary: #f9fafb;
  --color-text: #111827;
  --color-text-secondary: #6b7280;
}
```

To use a custom theme:

```javascript
// Static: Copy custom CSS after generation
import fs from 'fs';
import path from 'path';

const customCss = fs.readFileSync('custom-theme.css', 'utf-8');
const dashboardCss = path.join('docs/assets/css/dashboard.css');
fs.appendFileSync(dashboardCss, '\n\n' + customCss);
```

```javascript
// Server: Serve additional stylesheet
app.get('/custom-theme.css', (req, res) => {
  res.sendFile(path.join(__dirname, 'custom-theme.css'));
});

// Update dashboard config to include it
const dashboardConfig = {
  resultsDir: '.iudex/results',
  customCss: '/custom-theme.css'
};
```

### Configuration Options

```javascript
{
  // Output directory (static mode only)
  outputDir: '.iudex/dashboard',

  // Results directory to read test data from
  resultsDir: '.iudex/results',

  // Dashboard title
  title: 'My Test Dashboard',

  // Base path for server mode (e.g., '/test-dashboard')
  basePath: '/',

  // Theme (light or dark)
  theme: 'light',

  // Include historical runs (static mode)
  includeHistorical: true,

  // Max historical runs to include (static mode)
  historicalLimit: 50,

  // Database repository for analytics (server mode)
  repository: databaseRepository
}
```

---

## API Reference

### GitHubPagesReporter

```javascript
import { GitHubPagesReporter } from 'iudex/reporters/github-pages';

const reporter = new GitHubPagesReporter({
  outputDir: 'docs',
  title: 'Test Dashboard',
  includeHistorical: true,
  historicalLimit: 50
});

await reporter.report(resultCollector);
```

**Methods:**
- `report(collector)` - Generate static dashboard from test results

### DashboardServer

```javascript
import { DashboardServer } from 'iudex/server/dashboard-server';

const server = new DashboardServer({
  resultsDir: '.iudex/results',
  title: 'Test Dashboard',
  repository: dbRepository  // Optional
});

await server.handleRequest(req, res);
```

**Methods:**
- `handleRequest(req, res)` - Handle HTTP request
- `serveIndex(res)` - Serve dashboard HTML
- `serveAsset(pathname, res)` - Serve static asset
- `listRuns(searchParams, res)` - API: List runs
- `getRunDetails(runId, res)` - API: Get run details
- `getAnalytics(searchParams, res)` - API: Get analytics (if DB enabled)

### DataLoader (Client-side)

```javascript
import { DataLoader } from './data-loader.js';

const loader = new DataLoader({
  mode: 'server',  // or 'static'
  baseUrl: '/test-dashboard'
});

// Load runs
const runsIndex = await loader.loadRuns({ limit: 50 });

// Load specific run
const runData = await loader.loadRun('run-2026-01-27T17-06-04');

// Load analytics (server mode only)
const analytics = await loader.loadAnalytics('flaky-tests', {
  limit: 20,
  days: 30
});
```

---

## Troubleshooting

### Static Dashboard Not Loading

**Problem:** Dashboard shows blank page or errors in console.

**Solution:**
1. Check browser console for errors
2. Verify `data/runs.json` exists and is valid JSON
3. Ensure `<base href>` is set correctly in index.html
4. Try serving from a real web server (not `file://`)

```bash
# Serve locally
cd docs/
python3 -m http.server 8000
# Open http://localhost:8000
```

### Analytics Not Showing

**Problem:** Analytics tab shows "Analytics Not Available".

**Solutions:**

1. **Static mode:** Analytics require a server with database connection
   ```javascript
   // Static dashboards can't access PostgreSQL directly
   // Mount on a server instead
   ```

2. **Server mode:** Verify database repository is configured
   ```javascript
   app.use('/dashboard', createExpressDashboard({
     repository: databaseRepository  // Must be provided!
   }));
   ```

3. **Database connection:** Check PostgreSQL is running and accessible
   ```bash
   psql -h localhost -U postgres -d iudex -c "SELECT COUNT(*) FROM tests;"
   ```

### Historical Runs Not Appearing

**Problem:** Only latest run shows in dropdown.

**Solution:** Ensure JSON reporter is configured:

```javascript
// iudex.config.js
export default {
  reporters: [
    'console',
    'json',  // Add this! Creates run-*.json files
    'github-pages'
  ]
};
```

### CORS Errors in Server Mode

**Problem:** Browser blocks API requests due to CORS.

**Solution:** Add CORS headers:

```javascript
import cors from 'cors';

app.use(cors({
  origin: process.env.ALLOWED_ORIGINS?.split(',') || '*'
}));

app.use('/dashboard', createExpressDashboard({...}));
```

### Large Dashboard Files

**Problem:** Dashboard directory is too large for GitHub.

**Solutions:**

1. Limit historical runs:
   ```javascript
   {
     reporter: 'github-pages',
     config: {
       historicalLimit: 10  // Reduce from 50
     }
   }
   ```

2. Archive old runs:
   ```bash
   # Move old runs to archive
   mkdir .iudex/results/archive
   mv .iudex/results/run-2025-*.json .iudex/results/archive/
   ```

3. Use GitHub releases for large datasets:
   ```bash
   # Upload dashboard as release asset
   gh release create v1.0.0 --title "Test Dashboard" \
     --notes "Latest test results" dashboard.zip
   ```

---

## Examples

Complete working examples are available in the **[iudex-examples](https://github.com/yourusername/iudex-examples)** repository:

- **Static Dashboard** - GitHub Pages deployment with CI/CD
- **Express Server** - Dashboard with PostgreSQL analytics
- **Fastify Server** - Alternative server integration
- **Custom Themes** - Theme customization examples
- **Multi-Environment** - Deploying dashboards for staging/production

Clone the examples repo to get started quickly:

```bash
git clone https://github.com/yourusername/iudex-examples.git
cd iudex-examples/dashboard-examples
npm install
npm run example:static  # or example:server
```

---

## Next Steps

- **üìñ [Main README](../README.md)** - Project overview
- **üîê [Security Guide](./SECURITY.md)** - Security checks reference
- **‚öñÔ∏è [Governance Guide](./GOVERNANCE.md)** - API governance rules
- **üóÑÔ∏è [Database Schema](../database/schema.sql)** - PostgreSQL setup

---

**Questions or issues?** Open an issue on [GitHub](https://github.com/anthropics/iudex/issues)
